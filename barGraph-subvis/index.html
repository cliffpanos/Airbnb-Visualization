<!DOCTYPE html>

<!-- Y-axis: price
X-axis: room types

Filter by:
- # of people
- # average rating -->

<meta charset="utf-8">
<head>
<style>

.rectangle {
	fill: #9EC28F;
}
.rectangle:hover {
	fill: #83B39D;
}
.axis {
  font: 10px sans-serif;
}

.path {
    fill: steelblue;
    stroke: steelblue;
}
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
</style>
</head>
<body>
<div id="drop" align=center></div>
<script src="../assets/js/d3.min.js"></script>
<script>

var margin = {top: 80, right: 0, bottom: 80, left: 180},
    width = 700 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

var svg = d3.select("body").append("svg")
	.attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
	.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var neighborhoodSelected = "el Poble Sec";
var ratingSelected = 1;

var presentGraph = function(neighborhood, rating) {
    console.log(neighborhood);

    d3.csv("data/listings.csv", function(error, data){
    console.log(data.length);

    var computePrices = function(neighborhood, rating) {

        console.log("Rating is: " + rating);
        filtered = data.filter(function(d){
            return d.neighbourhood_cleansed == neighborhood && (d.review_scores_rating / 20) >= rating;
        });
        console.log("FILTERED LENGTH: " + filtered.length);
        var privateRooms = filtered.filter(function(d) { return d.room_type == "Private room"; });
        console.log("Private rooms: " + privateRooms.length);
        var privatePrice = d3.mean(privateRooms, function(d) { return parseInt(d.price.replace(/\$/g, '')); });
        console.log("Private Price: " + privatePrice);

        var sharedRooms = filtered.filter(function(d) { return d.room_type == "Shared room"; });
        console.log("Shared: " + sharedRooms.length);
        var sharedPrice = d3.mean(sharedRooms, function(d) { return parseInt(d.price.replace(/\$/g, '')); });
        console.log("Shared Price: " + sharedPrice);

        var fullHouse = filtered.filter(function(d) { return d.room_type == "Entire home/apt"; });
        console.log("Entire home: " + fullHouse.length);
        var fullPrice = d3.mean(fullHouse, function(d) { return parseInt(d.price.replace(/\$/g, '')); });
        console.log("Full Price: " + fullPrice);

        return [privatePrice, sharedPrice, fullPrice];
    }

    var priceNames = ["Private Room", "Shared Room", "Entire House"];
    var prices = computePrices(neighborhoodSelected, ratingSelected);

	var elements = [1, 2, 3, 4, 5];

	var y = d3.scaleLinear()
			.domain([0, d3.max(prices, function(d){
				return +d;
			})])
			.range([height, 0]);

	var x = d3.scaleBand()
            .range([0, width])
            .domain(priceNames.map(function(d) { return d; }));

    var xAxis = svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("font-size", "30")
        .call(d3.axisBottom(x));

    d3.selectAll("text")
        .attr("font-size", width / 55)
        .attr("dy", 15)
        .attr("y", 15)
        .attr("fill", "#353F39");

    d3.selectAll("path")
        .attr("stroke", "darkGrey");


	// var yAxis = svg.append("g")
    //       .call(d3.axisLeft(y));


	// svg.append("g")
    // 	.attr("class", "x axis")
    // 	.attr("transform", "translate(0," + height + ")")
    // 	.call(xAxis)
    // 	.selectAll("text")
    // 	.style("font-size", "8px")
    //   	.style("text-anchor", "end")
    //   	.attr("dx", "-.8em")
    //   	.attr("dy", "-.55em")
    //   	.attr("transform", "rotate(-90)" );


 // 	svg.append("g")
    // 	.attr("class", "y axis")
    // 	.call(yAxis);

	svg.selectAll("rectangle")
		.data(prices)
		.enter()
		.append("rect")
		.attr("class","rectangle")
		.attr("width", width/ (1.5 * prices.length))
        //.attr("rx", "5, 5, 0, 0")
		.attr("height", function(d){
			return height - y(+d);
		})
		.attr("x", function(d, i){
			return (width / prices.length) * i + (0.16 * width / prices.length);
		})
		.attr("y", function(d){
			return y(+d);
		});
		// .append("title")
		// .text(function(d, i){
		// 	return priceNames[i];
		// })
        // .attr("size", "40px");

    //Add bar labels
    svg.selectAll(".text")
  	   .data(prices)
  	   .enter()
  	   .append("text")
  	   .attr("class","label")
  	   .attr("x", (function(d, i) { return (width / prices.length) * i + (0.16 * width / prices.length) + width/ (3 * prices.length) - 15; }  ))
  	   .attr("y", function(d) { return y(d) + 10; })
  	   .attr("dy", ".75em")
       .attr("fill", "white")
       //.attr("fill", function(d) { return labelColorPicker(d); })
  	   .text(function(d) { return "$" + parseInt(d) });

	var selector = d3.select("#drop")
    	.append("select")
    	.attr("id","dropdown")
    	.on("change", function(d){

            ratingSelected = parseInt(document.getElementById("dropdown").value);
            console.log("Parsed:" + ratingSelected)
            svg.selectAll(".rectangle")
                .data(prices)
                .exit();
            prices = computePrices(neighborhoodSelected, ratingSelected);
        	y.domain([0, d3.max(prices, function(d){ return +d;})]);

            // y = d3.scaleLinear()
        	// 		.domain([0, d3.max(prices, function(d){ return +d; })])
        	// 		.range([height, 0]);
            console.log("Max y: " + d3.max(prices, function(d) { return +d }));

        	//d3.selectAll(".rectangle")
            svg.selectAll(".rectangle")
                .data(prices)
                .enter()
           		.transition()
        		.attr("height", function(d){
        			return height - y(+d);
        		})
        		.attr("x", function(d, i){
        			return (width / prices.length) * i + (0.16 * width / prices.length);
        		})
        		.attr("y", function(d){
                    console.log("d is: " + d);
                    console.log("New y:" + y(+d));
        			return y(+d);
        		})
           		.ease(d3.easeLinear);

            svg.selectAll(".label")
                .transition()
                .attr("y", function(d) { return y(+d) + 15; })
                .text(function(d, i) { return "$" + parseInt(prices[i]) })
                .ease(d3.easeLinear);

         });

    selector.selectAll("option")
      .data(elements)
      .enter().append("option")
      .attr("value", function(d){
        return d;
      })
      .text(function(d){
        return d;
      })


});

}
//Actually call the presentGraph function to populate the graph
presentGraph(neighborhoodSelected, ratingSelected);

</script>
</body>
